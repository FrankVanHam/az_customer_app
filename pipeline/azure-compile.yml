parameters:
  - name: AZ_DEBUG
    type: boolean
    
# variables import:
# - name: need_compile
# - name: AZ_FEED
# - name: SW_VERSION
# - name: CORE_DIR
# - name: EXTERNAL_DIR
# - name: MUNIT_TEST_ASPECTS

steps:
- task: JavaToolInstaller@1
  condition: eq(variables.need_compile, true)
  displayName: 'Activate java 17 sdk'
  inputs:
    versionSpec: '17'
    jdkArchitectureOption: 'x64'
    jdkSourceOption: 'PreInstalled'

- task: UniversalPackages@0
  condition: eq(variables.need_compile, true)
  displayName: 'Download the core application'
  inputs:
    command: download
    vstsFeed: '$(AZ_FEED)'
    vstsFeedPackage: 'cst.jar'
    vstsPackageVersion: $(SW_VERSION)
    downloadDirectory: '$(CORE_DIR)'

- script: |
    sudo java -Daccept_licences="YES" -Dinstall_language_packs="YES" -jar $(CORE_DIR)/core_installer.jar $(CORE_DIR) vsts vsts
  condition: eq(variables.need_compile, true)
  displayName: 'Install the core products'
  workingDirectory: $(Pipeline.Workspace)

- task: UniversalPackages@0
  condition: eq(variables.need_compile, true)
  displayName: 'Download munit'
  inputs:
    command: download
    vstsFeed: '$(AZ_FEED)'
    vstsFeedPackage: 'munit.zip'
    vstsPackageVersion: $(SW_VERSION)
    downloadDirectory: '$(EXTERNAL_DIR)'

- task: ExtractFiles@1
  condition: eq(variables.need_compile, true)
  displayName: 'Extract munit.zip'
  inputs:
    archiveFilePatterns: '$(EXTERNAL_DIR)/munit.zip'
    destinationFolder: '$(EXTERNAL_DIR)'
    cleanDestinationFolder: false

- task: DownloadPipelineArtifact@2
  condition: eq(variables.need_compile, true)
  displayName: 'Download the products_config.json for further steps'
  inputs:
    artifact: 'products_config'
    targetPath: '$(Pipeline.Workspace)'

- script: |
    $(CORE_DIR)/core/bin/share/runalias -j -Djava.awt.headless=true base -products_config $(Pipeline.Workspace)/products_config.json > compile.log
  condition: eq(variables.need_compile, true)
  displayName: 'Run the script $SW_MSF_STARTUP_MAGIK to compile and build'
  workingDirectory: '$(Pipeline.Workspace)'
  env:
    SW_MSF_STARTUP_MAGIK: '$(Build.SourcesDirectory)/scripts/compile_and_build.magik'
    customer_prd_BASE_DIR: '$(Build.SourcesDirectory)'
    SMALLWORLD_REGISTRY: '$(Build.SourcesDirectory)/smallworld_registry'

- task: PublishPipelineArtifact@1
  condition: and(eq(variables.need_compile, true), eq(${{parameters.AZ_DEBUG}}, true))
  displayName: 'Publish compile log for debugging purposes'
  inputs:
    targetPath: '$(Pipeline.Workspace)/compile.log'
    artifact: 'compile_log'
    publishLocation: 'pipeline'

- script: |
    $(CORE_DIR)/core/bin/share/runalias -j -Djava.awt.headless=true base -products_config $(Pipeline.Workspace)/products_config.json -test_output_dir $(Common.TestResultsDirectory) -test_aspects $(MUNIT_TEST_ASPECTS) > test_run.log
  condition: eq(variables.need_compile, true)
  displayName: 'Run the script /run_tests.magik to run the munit tests of the given aspects'
  workingDirectory: '$(Pipeline.Workspace)'
  timeoutInMinutes: 2
  env:
    SW_MSF_STARTUP_MAGIK: '$(Build.SourcesDirectory)/scripts/run_tests.magik'
    customer_prd_BASE_DIR: '$(Build.SourcesDirectory)'
    SMALLWORLD_REGISTRY: '$(Build.SourcesDirectory)/smallworld_registry'

- script: |
    cat test_run.log
  condition: and(eq(variables.need_compile, true), eq(${{parameters.AZ_DEBUG}}, true))
  displayName: 'Display testrun log'
  workingDirectory: '$(Pipeline.Workspace)'

- task: PythonScript@0
  condition: eq(variables.need_compile, true)
  displayName: 'Create NUnit test results from Magik test results'
  name: create_nunit_xml
  inputs:
    scriptSource: 'filePath'
    scriptPath: 'scripts/convert_magik_xml_to_nunit_xml.py'
    arguments: '$(Common.TestResultsDirectory) $(Pipeline.Workspace)/testresult.xml'
    failOnStderr: true

- task: PublishPipelineArtifact@1
  condition: and(eq(variables.need_compile, true), eq(${{parameters.AZ_DEBUG}}, true))
  displayName: 'publish testresult.xml for debugging purposes'
  inputs:
    targetPath: '$(Pipeline.Workspace)/testresult.xml'
    artifact: 'testresults.xml'
    publishLocation: 'pipeline'

- script: |
    cat $(Pipeline.Workspace)/testresult.xml
  condition: eq(variables.need_compile, true)
  displayName: 'Display converted NUnit test results'

- task: PublishTestResults@2
  condition: eq(variables.need_compile, true)
  displayName: 'Publish MUnit test results'
  inputs:
    testResultsFormat: 'NUnit'
    testResultsFiles: '$(Pipeline.Workspace)/testresult.xml'
    failTaskOnFailedTests: true
