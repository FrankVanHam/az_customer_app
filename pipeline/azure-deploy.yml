# set variables. Get the volatile one from the library group. The rest is set to point to directories for easy reading
variables:
  - group: customer-app-vars

pool:
  vmImage: 'Ubuntu-latest'

# Deployment job
jobs:
- job: Prepare
  steps:
  - checkout: self
    displayName: Checkout just the artifacts
    sparseCheckoutPatterns: ./artifacts.json
    fetchDepth: 0
  - script: |
      ls -al
      echo '##vso[task.setvariable variable=products_config;isOutput=true]'$(cat $(Pipeline.Workspace)/products_config.json)
    displayName: 'Set pipeline products_config variable from the products_config.json file'
    name: detect_products


# - deployment: Deploy_VM_with_customer_prd
#   displayName: 'Deploy Customer App on VMFrank'
#   dependsOn: Prepare
#   environment: 
#     name: 'Customer_App_dev.VMFrank'
#   strategy:
#     runOnce:
#       deploy:
#         steps:
#         # upload customer app
#         - task: UniversalPackages@0
#           displayName: 'Download customer app artifact'
#           inputs:
#             command: download
#             vstsFeed: '$(AZ_FEED)'
#             vstsFeedPackage: $(CUSTOMER_ARTIFACT)
#             vstsPackageVersion: '*'
#             downloadDirectory: '$(System.DefaultWorkingDirectory)'
#         - task: UniversalPackages@0
#           displayName: 'Download smallworld_registry'
#           inputs:
#             command: download
#             vstsFeed: '$(AZ_FEED)'
#             vstsFeedPackage: $(REGISTRY_ARTIFACT)
#             vstsPackageVersion: '*'
#             downloadDirectory: '$(System.DefaultWorkingDirectory)'
#         - task: UniversalPackages@0
#           displayName: 'Download run folder'
#           inputs:
#             command: download
#             vstsFeed: '$(AZ_FEED)'
#             vstsFeedPackage: $(RUN_ARTIFACT)
#             vstsPackageVersion: '*'
#             downloadDirectory: '$(System.DefaultWorkingDirectory)'

#         - task: ExtractFiles@1
#           displayName: 'Extract custom app artifact to the designated directory on the target server'
#           inputs:
#             archiveFilePatterns: '*.zip'
#             destinationFolder: $(DEPLOY_DIR)
#             cleanDestinationFolder: false



# - job: Deploy
#   dependsOn: [Prepare]
#   strategy: 
#     matrix: $[dependencies.Download.outputs['detect_products.products_config']]
#   steps:
#   - template: azure-package.yml
#     parameters:
#       AZ_DEBUG: ${{parameters.AZ_DEBUG}}