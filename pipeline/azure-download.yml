# variables import:
# - name: ADDITIONAL_ARTIFACT_DIRS
# - name: AZ_BUILD_ALL
# - name: AZ_BUILD_THIS

steps:

- checkout: self
  displayName: 'Checkout the repository'
  persistCredentials: true
  fetchDepth: 2

- script: |
    echo '$(parameters.AZ_BUILD_ALL)'
    echo '$(parameters.AZ_BUILD_THIS)'

- ${{ if eq(parameters.AZ_BUILD_ALL, true) }}:
  - script: |
      cp ./artifact.json $(Pipeline.Workspace)/products_config.json
    displayName: 'Build all products - copy artifact.json to products_config.json'
- ${{ elseif ne(parameters.AZ_BUILD_THIS, '') }}:
  - script: |
      echo ${variables.AZ_BUILD_THIS} > $(Pipeline.Workspace)/products_config.json
    displayName: 'Build this product - set products_config.json to AZ_BUILD_THIS variable'
- ${{ else }}:
  - script: |
      git diff --name-only HEAD HEAD~1 > $(Pipeline.Workspace)/changed_files.txt
    displayName: 'Get changed files and store them in changed_files.txt'

  - task: PublishPipelineArtifact@1
    condition: eq(variables.AZ_DEBUG, true)
    displayName: 'Publish changed_files.txt for debugging purposes'
    inputs:
      targetPath: '$(Pipeline.Workspace)/changed_files.txt'
      artifact: 'changed_files'
      publishLocation: 'pipeline'

  - task: PythonScript@0
    displayName: 'Detect products'
    name: detect_changes
    inputs:
      scriptSource: 'filePath'
      scriptPath: 'scripts/detect_products.py'
      arguments: '$(Pipeline.Workspace)/changed_files.txt ./artifacts.json $(Pipeline.Workspace)/products_config.json'
      failOnStderr: true
# ${{ endif }}

- script: |
    echo '##vso[task.setvariable variable=products_config;isOutput=true]'$(cat $(Pipeline.Workspace)/products_config.json)
  displayName: 'Set pipeline products_config variable from the products_config.json file'
  name: detect_products

- task: PublishPipelineArtifact@1
  displayName: 'Publish products_config.json for the next jobs'
  inputs:
    targetPath: '$(Pipeline.Workspace)/products_config.json'
    artifact: 'products_config'
    publishLocation: 'pipeline'
